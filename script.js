// trimmed due to length in this preview, but full script from my previous answer goes here